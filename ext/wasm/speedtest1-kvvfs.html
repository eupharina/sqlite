<!doctype html>
<html lang="en-us">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <link rel="shortcut icon" href="data:image/x-icon;," type="image/x-icon">
    <link rel="stylesheet" href="common/emscripten.css"/>
    <link rel="stylesheet" href="common/testing.css"/>
    <title>speedtest1-kvvfs.wasm</title>
  </head>
  <body>
    <header id='titlebar'><span>speedtest1-kvvfs.wasm</span></header>
    <div>See also: <a href='speedtest1-worker.html'>A Worker-thread variant of this page.</a></div>
    <!-- emscripten bits -->
    <figure id="module-spinner">
      <div class="spinner"></div>
      <div class='center'><strong>Initializing app...</strong></div>
      <div class='center'>
        On a slow internet connection this may take a moment.  If this
        message displays for "a long time", intialization may have
        failed and the JavaScript console may contain clues as to why.
      </div>
    </figure>
    <div class="emscripten" id="module-status">Downloading...</div>
    <div class="emscripten">
      <progress value="0" max="100" id="module-progress" hidden='1'></progress>  
    </div><!-- /emscripten bits -->
    <div class='warning'>This page starts running the main exe when it loads, which will
      block the UI until it finishes! Adding UI controls to manually configure and start it
      are TODO.</div>
    </div>
    <div class='warning'>Achtung: running it with the dev tools open may
      <em>drastically</em> slow it down. For faster results, keep the dev
      tools closed when running it!
    </div>
    <div>Output is delayed/buffered because we cannot update the UI while the
      speedtest is running. Output will appear below when ready...
    <div id='test-output'></div>
    <script src="common/whwasmutil.js"></script>
    <script src="common/SqliteTestUtil.js"></script>
    <script src="speedtest1-kvvfs.js"></script>
    <script>(function(){
        const eOut = document.querySelector('#test-output');
        const log2 = function(cssClass,...args){
          const ln = document.createElement('div');
          if(cssClass) ln.classList.add(cssClass);
          ln.append(document.createTextNode(args.join(' ')));
          eOut.append(ln);
        };
        const logList = [
        ] /* We can't update DOM while speedtest and kvvfs only works
             in the main thread, so we queue up main()-time output
             into logList. */;
        const dumpLogList = function(){
          logList.forEach((v)=>log2('',v));
          logList.length = 0;
        };
        const log = (...args)=>{
          console.log(...args);
          logList.push(args.join(' '));
        };
        const logErr = function(...args){
          console.error(...args);
          logList.push('ERROR: '+args.join(' '));
        };

        const guessStorageSize = function(which=''){
          let sz = 0;
          const prefix = 'kvvfs-'+which;
          [localStorage,sessionStorage].forEach((s)=>{
            let i;
            for(i = 0; i < s.length; ++i){
              const k = s.key(i);
              if(k.startsWith(prefix)){
                sz += k.length;
                sz += s.getItem(k).length;
              }
            }
          });
          return sz * 2 /* for 16-bit-char encoding */;
        };
        const clearStorage = function(){
            sessionStorage.clear();
            localStorage.clear();
        };
        const runTests = function(EmscriptenModule){
          console.log("Module inited.",EmscriptenModule);
            
          const wasm = {
            exports: EmscriptenModule.asm,
            alloc: (n)=>EmscriptenModule._malloc(n),
            dealloc: (m)=>EmscriptenModule._free(m),
            memory: EmscriptenModule.asm.memory || EmscriptenModule.wasmMemory
          };
          log2('warning',"Clearing session/local storage before test starts.");
          clearStorage();
          //console.debug('wasm =',wasm);
          self.WhWasmUtilInstaller(wasm);
          const scope = wasm.scopedAllocPush();
          const dbFile = 0 ? "session" : "local";
          const urlArgs = self.SqliteTestUtil.processUrlArgs();
          const argv = ["speedtest1", "--size", "5"];
          if(urlArgs.flags){
            // transform flags=a,b,c to ["--a", "--b", "--c"]
            argv.push(...(urlArgs.flags.split(',').map((v)=>'--'+v)));
          }else{
            argv.push(
              "--singlethread",
              "--nomutex",
              //"--nosync",
              "--nomemstat"
              //  ,"--sqlonly"
            );
            //argv.push("--memdb" /* note that memdb trumps the filename arg */);
          }
          argv.push("--big-transactions"/*important for tests 410 and 510!*/,
                    dbFile);
          if(argv.indexOf('--memdb')>=0){
              log2('error',"WARNING: --memdb flag trumps db filename.");
          }
          console.log("argv =",argv);
          // These log messages are not emitted to the UI until after main() returns. Fixing that
          // requires moving the main() call and related cleanup into a timeout handler.
          log2('',"Starting native app:\n ",argv.join(' '));
          log2('',"This will take a while and the browser might warn about the runaway JS.",
               "Give it time...");
          logList.length = 0;
          new Promise(function(resolve,reject){
            setTimeout(function(){
              try {
                wasm.xCall('__main_argc_argv', argv.length,
                           wasm.scopedAllocMainArgv(argv));
              }catch(e){
                reject(e);
              }
              resolve();
            }, 50);
          }).finally(function(){
            wasm.scopedAllocPop(scope);
            logList.unshift("Done running native main(). Output:");
            dumpLogList();
            log2('',"Approximate",dbFile,"storage usage:",guessStorageSize(),"bytes");
            log2('warning',"Clearing",dbFile,"storage.");
            clearStorage(dbFile);
          });
        }/*runTests()*/;

        self.sqlite3TestModule.print = log;
        self.sqlite3TestModule.printErr = logErr;
        sqlite3Speedtest1InitModule(self.sqlite3TestModule).then(function(M){
          setTimeout(()=>runTests(M), 100);
        });
      })();
    </script>
  </body>
</html>
